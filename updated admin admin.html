<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starzone Updator - Complete Admin Panel</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --color-primary: #4361ee;
            --color-secondary: #3a0ca3;
            --color-success: #4cc9f0;
            --color-warning: #f72585;
            --color-danger: #e63946;
            --color-info: #4895ef;
            --color-dark: #1d3557;
            --color-light: #f1faee;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-light: #f8fafc;
            --text-muted: #94a3b8;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: var(--text-light); 
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        .login-container {
            max-width: 450px;
            margin: 80px auto;
            padding: 40px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h2 {
            color: var(--color-success);
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .btn { 
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 10px; 
            cursor: pointer; 
            margin: 5px; 
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
        }
        
        .btn-success { 
            background: linear-gradient(135deg, var(--color-success), #4895ef);
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, var(--color-danger), var(--color-warning));
        }
        
        .btn-warning { 
            background: linear-gradient(135deg, var(--color-warning), #e9c46a);
        }
        
        .btn-info { 
            background: linear-gradient(135deg, var(--color-info), #3a86ff);
        }
        
        .btn:disabled {
            background: #475569;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .form-group { 
            margin-bottom: 20px; 
        }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: var(--color-success);
        }
        
        input, textarea, select { 
            width: 100%; 
            padding: 14px; 
            border-radius: 10px; 
            border: 2px solid rgba(255, 255, 255, 0.1); 
            background: rgba(0, 0, 0, 0.3); 
            color: var(--text-light); 
            margin-bottom: 10px; 
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
            background: rgba(0, 0, 0, 0.4);
        }
        
        .hidden { 
            display: none; 
        }
        
        .alert { 
            padding: 15px; 
            border-radius: 10px; 
            margin: 15px 0; 
            border-left: 4px solid;
        }
        
        .alert-success { 
            background: rgba(76, 201, 240, 0.1); 
            color: var(--color-success);
            border-left-color: var(--color-success);
        }
        
        .alert-error { 
            background: rgba(230, 57, 70, 0.1); 
            color: var(--color-danger);
            border-left-color: var(--color-danger);
        }
        
        .alert-warning { 
            background: rgba(245, 158, 11, 0.1); 
            color: #f59e0b;
            border-left-color: #f59e0b;
        }
        
        .card { 
            background: var(--bg-card); 
            border-radius: 15px; 
            padding: 25px; 
            margin-bottom: 25px; 
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-title { 
            color: var(--color-success); 
            margin-bottom: 20px; 
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
            table-layout: fixed;
        }
        
        th, td { 
            padding: 15px; 
            text-align: left; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.05); 
            word-wrap: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        th {
            background: rgba(0, 0, 0, 0.3);
            color: var(--color-success);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .email-column {
            width: 20%;
        }
        
        .device-column {
            width: 10%;
        }
        
        .expiration-column {
            width: 20%;
        }
        
        .status-column {
            width: 10%;
        }
        
        .actions-column {
            width: 40%;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--color-dark), var(--bg-card));
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--color-success);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 25px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 5px;
        }
        
        .tab {
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            flex: 1;
        }
        
        .tab.active {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .status-badge { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 0.8rem; 
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-active { 
            background: rgba(76, 201, 240, 0.2); 
            color: var(--color-success);
            border: 1px solid rgba(76, 201, 240, 0.3);
        }
        
        .status-expired { 
            background: rgba(230, 57, 70, 0.2); 
            color: var(--color-danger);
            border: 1px solid rgba(230, 57, 70, 0.3);
        }
        
        .status-banned { 
            background: rgba(245, 158, 11, 0.2); 
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .device-list {
            margin-top: 15px;
        }
        
        .device-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .device-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }
        
        .device-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.8rem;
        }
        
        .device-banned {
            border-left: 4px solid var(--color-danger);
            background: rgba(230, 57, 70, 0.1);
        }
        
        .device-active {
            border-left: 4px solid var(--color-success);
        }
        
        .expiration-date {
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .expiration-expired {
            color: var(--color-danger);
            font-weight: 600;
        }
        
        .expiration-soon {
            color: var(--color-warning);
            font-weight: 600;
        }
        
        .maintenance-banner {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #f59e0b;
            animation: pulse 2s infinite;
        }
        
        .maintenance-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        .maintenance-time {
            font-family: monospace;
            background: rgba(0,0,0,0.2);
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin: 5px 0;
        }
        
        .password-toggle {
            position: relative;
        }
        
        .password-toggle input {
            padding-right: 40px;
        }
        
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
        }
        
        .current-password {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .current-user-key {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .share-content {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-family: monospace;
            white-space: pre-line;
            line-height: 1.5;
        }
        
        .update-notes {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .update-item {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
        }
        
        .user-type-tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 5px;
        }
        
        .user-type-tab {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            flex: 1;
        }
        
        .user-type-tab.active {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .device-info {
                grid-template-columns: 1fr;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .email-column, .device-column, .expiration-column, .status-column, .actions-column {
                width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <h2>üîê Admin Login</h2>
                <p>Starzone Updator Control Panel</p>
            </div>
            <div id="loginAlert"></div>
            <div class="form-group">
                <label for="adminEmail">Email:</label>
                <input type="email" id="adminEmail" placeholder="Enter email" value="admin@starzone.com">
            </div>
            <div class="form-group">
                <label for="adminPassword">Password:</label>
                <input type="password" id="adminPassword" placeholder="Enter password" value="Admin123!">
            </div>
            <button class="btn" id="loginBtn" onclick="loginUser()" style="width: 100%; margin-top: 20px;">Login to Dashboard</button>
            
            <div style="margin-top: 25px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; font-size: 0.9em;">
                <strong style="color: var(--color-success);">Auto-Create System:</strong><br>
                <div>Just click login - accounts will be created automatically!</div>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: rgba(67, 97, 238, 0.1); border-radius: 8px; font-size: 0.8em;">
                <strong>üîß Connected to:</strong><br>
                Project: waffujus-shop<br>
                Database: waffujus-shop-default-rtdb
            </div>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="adminPanel" class="hidden">
        <div class="container">
            <header>
                <div class="header-content">
                    <div>
                        <h1>üöÄ Starzone Updator - Complete Admin Panel</h1>
                        <p style="opacity: 0.9;">Connected to: waffujus-shop Firebase Project</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="adminUserEmail" style="font-weight: 600;"></span>
                        <button class="btn btn-danger" onclick="logoutAdmin()">üö™ Logout</button>
                    </div>
                </div>
            </header>

            <div id="adminAlert"></div>

            <!-- Maintenance Banner -->
            <div id="maintenanceBanner" class="maintenance-banner hidden">
                <div class="maintenance-title">üöß SYSTEM MAINTENANCE ACTIVE</div>
                <div id="maintenanceMessage">Maintenance in progress...</div>
                <div>Started: <span id="maintenanceTime" class="maintenance-time">Loading...</span></div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('adminTab')">üë• User Management</div>
                <div class="tab" onclick="switchTab('systemTab')">‚öôÔ∏è System Setup</div>
            </div>

            <!-- User Management Tab -->
            <div id="adminTab" class="tab-content active">
                <!-- User Type Tabs -->
                <div class="user-type-tabs">
                    <div class="user-type-tab active" onclick="switchUserType('all')">All Users</div>
                    <div class="user-type-tab" onclick="switchUserType('admins')">Administrators</div>
                    <div class="user-type-tab" onclick="switchUserType('users')">Users</div>
                </div>

                <!-- Statistics Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statActiveUsers">0</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statBannedUsers">0</div>
                        <div class="stat-label">Banned Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalDevices">0</div>
                        <div class="stat-label">Total Devices</div>
                    </div>
                </div>

                <!-- User Management -->
                <div class="card">
                    <div class="card-title">
                        üë• User Management
                        <button class="btn btn-success" onclick="showCreateUserModal()">+ Create New User</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="email-column">Email</th>
                                    <th class="device-column">Device Limit</th>
                                    <th class="device-column">Devices Used</th>
                                    <th class="expiration-column">Expiration</th>
                                    <th class="status-column">Status</th>
                                    <th class="actions-column">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="6" style="text-align: center;">Loading users...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Banned Users -->
                <div class="card">
                    <div class="card-title">üö´ Banned Users</div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="email-column">Email</th>
                                    <th class="expiration-column">Ban Reason</th>
                                    <th class="expiration-column">Ban Date</th>
                                    <th class="actions-column">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bannedTableBody">
                                <tr><td colspan="4" style="text-align: center;">No banned users</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- System Settings Tab -->
            <div id="systemTab" class="tab-content">
                <div class="card">
                    <div class="card-title">‚öôÔ∏è System Settings</div>
                    <div class="form-group">
                        <label for="systemName">System Name:</label>
                        <input type="text" id="systemName" value="Starzone Updator v3.1">
                    </div>
                    <div class="form-group">
                        <label for="systemVersion">System Version:</label>
                        <input type="text" id="systemVersion" value="v3.1">
                    </div>
                    <div class="form-group">
                        <label for="defaultDeviceLimit">Default Device Limit:</label>
                        <input type="number" id="defaultDeviceLimit" value="3" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label for="defaultSubscriptionDays">Default Subscription Days:</label>
                        <input type="number" id="defaultSubscriptionDays" value="30" min="1" max="365">
                    </div>
                    <div class="form-group">
                        <label for="forgotPasswordUrl">Forgot Password URL:</label>
                        <input type="text" id="forgotPasswordUrl" placeholder="https://t.me/r3nz75" value="https://t.me/r3nz75">
                        <small style="color: var(--text-muted);">Users will be directed to this URL when they click "Forgot Password"</small>
                    </div>
                    
                    <button class="btn btn-success" onclick="saveSystemSettings()">üíæ Save System Settings</button>
                </div>

                <div class="card">
                    <div class="card-title">üîÑ Update Management</div>
                    <div class="form-group">
                        <label for="updateVersion">Update Version:</label>
                        <input type="text" id="updateVersion" placeholder="e.g., v3.2">
                    </div>
                    <div class="form-group">
                        <label for="updateTitle">Update Title:</label>
                        <input type="text" id="updateTitle" placeholder="e.g., New Features Added">
                    </div>
                    <div class="form-group">
                        <label id="updateNotesLabel" for="updateNotes">Update Notes (one per line):</label>
                        <textarea id="updateNotes" placeholder="‚Ä¢ New feature 1&#10;‚Ä¢ Bug fix 1&#10;‚Ä¢ Improvement 1" rows="5"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="updateType">Update Type:</label>
                        <select id="updateType">
                            <option value="feature">Feature Update</option>
                            <option value="bugfix">Bug Fix</option>
                            <option value="security">Security Update</option>
                            <option value="maintenance">Maintenance</option>
                        </select>
                    </div>
                    <button class="btn btn-info" onclick="publishUpdate()">üöÄ Publish Update</button>
                    
                    <div class="update-notes hidden" id="currentUpdateInfo">
                        <strong>Current Update:</strong>
                        <div id="currentUpdateDetails"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üöß Maintenance Control</div>
                    <div class="form-group">
                        <label for="maintenanceReason">Maintenance Reason:</label>
                        <textarea id="maintenanceReason" placeholder="Enter reason for maintenance" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Maintenance Status:</label>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-warning" onclick="startMaintenance()">Start Maintenance</button>
                            <button class="btn btn-success" onclick="stopMaintenance()">Stop Maintenance</button>
                        </div>
                    </div>
                    <div id="currentMaintenanceInfo" style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; display: none;">
                        <strong>Current Maintenance:</strong>
                        <div id="currentMaintenanceDetails"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üöÄ Quick Setup</div>
                    <div style="padding: 20px;">
                        <p><strong>Current Status:</strong> <span id="setupStatus">Checking...</span></p>
                        <div class="btn-group" style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="initializeDemoData()">üì¶ Create Demo Data</button>
                            <button class="btn btn-info" onclick="createDemoUsers()">üë• Create Demo Users</button>
                            <button class="btn" onclick="testDatabaseConnection()">üîç Test Connection</button>
                            <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Reset All Data</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--color-success); margin-bottom: 20px;">Create New User</h3>
            <div class="form-group">
                <label for="userEmail">Email Address:</label>
                <input type="email" id="userEmail" placeholder="user@example.com">
            </div>
            <div class="form-group">
                <label for="userKey">User Key (for login):</label>
                <input type="text" id="userKey" placeholder="Enter unique user key" value="USER123">
                <small style="color: var(--text-muted);">Users will use this key + password to login</small>
            </div>
            <div class="form-group password-toggle">
                <label for="userPassword">Password:</label>
                <input type="password" id="userPassword" placeholder="User password (min 6 chars)" value="User123!">
                <button type="button" class="toggle-password" onclick="togglePassword('userPassword')">üëÅÔ∏è</button>
            </div>
            <div class="form-group">
                <label for="userRole">User Role:</label>
                <select id="userRole">
                    <option value="user">User</option>
                    <option value="admin">Administrator</option>
                </select>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label for="userDeviceLimit">Device Limit:</label>
                    <input type="number" id="userDeviceLimit" value="3" min="1" max="20">
                </div>
                <div class="form-group">
                    <label for="userExpiration">Subscription Days:</label>
                    <input type="number" id="userExpiration" value="30" min="1" max="365">
                </div>
            </div>
            
            <button class="btn btn-success" onclick="createUser()" style="width: 100%; margin-top: 20px;">Create User Account</button>
            <button class="btn" onclick="closeModal('createUserModal')" style="width: 100%; margin-top: 10px; background: rgba(255,255,255,0.1);">Cancel</button>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--color-success); margin-bottom: 20px;">Edit User</h3>
            <div class="form-group">
                <label for="editExpirationDate">Expiration Date (YYYY-MM-DD HH:MM:SS AM/PM):</label>
                <input type="text" id="editExpirationDate" placeholder="2025-10-10 03:37:46 AM">
                <small style="color: var(--text-muted);">Format: YYYY-MM-DD HH:MM:SS AM/PM</small>
            </div>
            
            <div class="form-group">
                <label for="editDeviceLimit">Device Limit:</label>
                <input type="number" id="editDeviceLimit" min="1" max="20">
            </div>
            
            <div class="form-group">
                <label>Current User Key:</label>
                <div class="current-user-key">
                    <span id="currentUserKeyDisplay">Loading...</span>
                    <button type="button" class="toggle-password" onclick="toggleCurrentUserKey()" style="margin-left: 10px;">üëÅÔ∏è</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Current Password:</label>
                <div class="current-password">
                    <span id="currentPasswordDisplay">Loading...</span>
                    <button type="button" class="toggle-password" onclick="toggleCurrentPassword()" style="margin-left: 10px;">üëÅÔ∏è</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="editUserKey">New User Key:</label>
                <input type="text" id="editUserKey" placeholder="Leave empty to keep current user key">
                <small style="color: var(--text-muted);">Users need this key + password to login</small>
            </div>
            
            <div class="form-group password-toggle">
                <label for="editUserPassword">New Password:</label>
                <input type="password" id="editUserPassword" placeholder="Leave empty to keep current password">
                <button type="button" class="toggle-password" onclick="togglePassword('editUserPassword')">üëÅÔ∏è</button>
                <small style="color: var(--text-muted);">Minimum 6 characters</small>
            </div>
            
            <button class="btn btn-success" onclick="saveUserEdits()" style="width: 100%; margin-top: 20px;">Save Changes</button>
            <button class="btn" onclick="closeModal('editUserModal')" style="width: 100%; margin-top: 10px; background: rgba(255,255,255,0.1);">Cancel</button>
        </div>
    </div>

    <!-- Share User Modal -->
    <div id="shareUserModal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--color-info); margin-bottom: 20px;">üì§ Share Account Details</h3>
            <div class="share-content" id="shareContent">
                Account: user@example.com
                User Key: ********
                Password: ********
                Expiration: 2025-10-10 10:46:45 AM
                Created: 2025-10-08 10:46:45 AM
                Device Logged: 1/10
                Device Limit: 10
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-info" onclick="copyShareContent()" style="flex: 1;">üìã Copy to Clipboard</button>
                <button class="btn" onclick="closeModal('shareUserModal')" style="flex: 1; background: rgba(255,255,255,0.1);">Close</button>
            </div>
        </div>
    </div>

    <!-- View Devices Modal -->
    <div id="viewDevicesModal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--color-success); margin-bottom: 20px;">üì± User Devices</h3>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div id="devicesModalTitle">Devices for: Loading...</div>
                <button class="btn btn-danger btn-sm" onclick="removeAllDevices()">Remove All Devices</button>
            </div>
            <div id="devicesModalContent">
                <div class="device-list" id="devicesList">
                    <!-- Devices will be loaded here -->
                </div>
            </div>
            <button class="btn" onclick="closeModal('viewDevicesModal')" style="width: 100%; margin-top: 20px; background: rgba(255,255,255,0.1);">Close</button>
        </div>
    </div>

    <!-- Ban Device Modal -->
    <div id="banDeviceModal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--color-warning); margin-bottom: 20px;">üö´ Ban Device</h3>
            <div class="form-group">
                <label for="banDeviceReason">Ban Reason:</label>
                <input type="text" id="banDeviceReason" placeholder="Enter ban reason">
            </div>
            <div class="form-group">
                <label for="banDeviceNotes">Additional Notes:</label>
                <textarea id="banDeviceNotes" placeholder="Optional notes" rows="3"></textarea>
            </div>
            <button class="btn btn-warning" onclick="confirmBanDevice()" style="width: 100%;">Ban Device</button>
            <button class="btn" onclick="closeModal('banDeviceModal')" style="width: 100%; margin-top: 10px; background: rgba(255,255,255,0.1);">Cancel</button>
        </div>
    </div>

    <script>
        // Firebase Configuration - Using YOUR waffujus-shop project
        const firebaseConfig = {
            apiKey: "AIzaSyAU3TqXxMTwzRApmO00QdOnvwUrqq03mZ0",
            authDomain: "waffujus-shop.firebaseapp.com",
            databaseURL: "https://waffujus-shop-default-rtdb.firebaseio.com",
            projectId: "waffujus-shop",
            storageBucket: "waffujus-shop.firebasestorage.app",
            messagingSenderId: "783507114347",
            appId: "1:783507114347:android:6431a97ec8acf650e4642e"
        };

        // Initialize Firebase
        let app;
        let auth;
        let rdb;

        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            rdb = firebase.database();
            console.log('‚úÖ Firebase initialized successfully');
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
        }

        let currentUser = null;
        let selectedUserId = null;
        let selectedDeviceId = null;
        let currentUserKeyVisible = false;
        let currentPasswordVisible = false;
        let currentUserKey = '';
        let currentUserPassword = '';
        let currentUserType = 'all';

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
        }

        // Toggle current user key visibility
        function toggleCurrentUserKey() {
            currentUserKeyVisible = !currentUserKeyVisible;
            const display = document.getElementById('currentUserKeyDisplay');
            if (currentUserKeyVisible) {
                display.textContent = currentUserKey;
            } else {
                display.textContent = '‚Ä¢'.repeat(currentUserKey.length);
            }
        }

        // Toggle current password visibility
        function toggleCurrentPassword() {
            currentPasswordVisible = !currentPasswordVisible;
            const display = document.getElementById('currentPasswordDisplay');
            if (currentPasswordVisible) {
                display.textContent = currentUserPassword;
            } else {
                display.textContent = '‚Ä¢'.repeat(currentUserPassword.length);
            }
        }

        // Format date to 12-hour format (YYYY-MM-DD HH:MM:SS AM/PM)
        function formatDateTime12hr(dateString) {
            if (!dateString) {
                return 'No date';
            }
            
            try {
                const date = new Date(dateString);
                
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    return 'Invalid date format';
                }
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                let hours = date.getHours();
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                
                hours = hours % 12;
                hours = hours ? hours : 12; // the hour '0' should be '12'
                hours = String(hours).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds} ${ampm}`;
            } catch (error) {
                console.error('Error formatting date:', error);
                return 'Date format error';
            }
        }

        // Parse 12-hour format date string to Date object
        function parseDateTime12hr(dateTimeString) {
            if (!dateTimeString) return null;
            
            // Regex to match format: YYYY-MM-DD HH:MM:SS AM/PM
            const regex = /^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2}) (AM|PM)$/;
            const match = dateTimeString.match(regex);
            
            if (!match) {
                // Try without seconds
                const regex2 = /^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}) (AM|PM)$/;
                const match2 = dateTimeString.match(regex2);
                
                if (!match2) {
                    return null;
                }
                
                const [, year, month, day, hour, minute, ampm] = match2;
                let hours = parseInt(hour);
                
                if (ampm === 'PM' && hours < 12) hours += 12;
                if (ampm === 'AM' && hours === 12) hours = 0;
                
                return new Date(year, month - 1, day, hours, parseInt(minute), 0);
            }
            
            const [, year, month, day, hour, minute, second, ampm] = match;
            let hours = parseInt(hour);
            
            if (ampm === 'PM' && hours < 12) hours += 12;
            if (ampm === 'AM' && hours === 12) hours = 0;
            
            return new Date(year, month - 1, day, hours, parseInt(minute), parseInt(second));
        }

        // Format date for expiration display (12-hour format)
        function formatExpirationDate(dateString) {
            if (!dateString) {
                return 'No expiration date';
            }
            
            try {
                const date = new Date(dateString);
                
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    return 'Invalid date format';
                }
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                let hours = date.getHours();
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                
                hours = hours % 12;
                hours = hours ? hours : 12; // the hour '0' should be '12'
                hours = String(hours).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds} ${ampm}`;
            } catch (error) {
                console.error('Error formatting date:', error);
                return 'Date format error';
            }
        }

        // Initialize the application
        function initApp() {
            if (!auth) {
                showAlert(document.getElementById('loginAlert'), '‚ùå Firebase not initialized. Check console for errors.', 'error');
                return;
            }

            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    document.getElementById('adminUserEmail').textContent = user.email;
                    loadAllData();
                    checkSetupStatus();
                    loadSystemSettings();
                    checkMaintenanceStatus();
                    checkCurrentUpdate();
                } else {
                    currentUser = null;
                    document.getElementById('loginScreen').classList.remove('hidden');
                    document.getElementById('adminPanel').classList.add('hidden');
                }
            });
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // User Type switching
        function switchUserType(type) {
            currentUserType = type;
            document.querySelectorAll('.user-type-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            loadUsers();
        }

        // Modal functions
        function showCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        async function loginUser() {
            if (!auth) {
                showAlert(document.getElementById('loginAlert'), '‚ùå Firebase not available', 'error');
                return;
            }

            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const alertDiv = document.getElementById('loginAlert');
            const loginBtn = document.getElementById('loginBtn');

            if (!email || !password) {
                showAlert(alertDiv, 'Please enter both email and password', 'error');
                return;
            }

            // Update UI
            loginBtn.disabled = true;
            loginBtn.textContent = 'Authenticating...';
            showAlert(alertDiv, 'üîê Attempting login...', 'success');

            try {
                // Try to sign in first
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                showAlert(alertDiv, '‚úÖ Login successful!', 'success');
                
            } catch (error) {
                if (error.code === 'auth/invalid-login-credentials' || error.code === 'auth/user-not-found') {
                    // User doesn't exist - create them automatically
                    showAlert(alertDiv, 'üîÑ Creating new admin account...', 'success');
                    
                    try {
                        // Create user in Firebase Authentication
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        const userId = userCredential.user.uid;
                        
                        // Create user data in Realtime Database
                        const userData = {
                            email: email,
                            user_key: 'ADMIN123', // Default admin key
                            device_limit: 10,
                            expiration: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(),
                            devices: {},
                            created_at: new Date().toISOString(),
                            status: 'active',
                            role: 'admin'
                        };

                        await rdb.ref('users/' + userId).set(userData);
                        showAlert(alertDiv, '‚úÖ Admin account created successfully!', 'success');
                        
                    } catch (createError) {
                        console.error('Error creating user:', createError);
                        let createErrorMessage = 'Error creating account: ' + createError.message;
                        
                        if (createError.code === 'auth/email-already-in-use') {
                            createErrorMessage = 'Email already exists. Please try logging in instead.';
                        } else if (createError.code === 'auth/weak-password') {
                            createErrorMessage = 'Password is too weak. Please use a stronger password.';
                        }
                        
                        showAlert(alertDiv, '‚ùå ' + createErrorMessage, 'error');
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Login to Dashboard';
                    }
                } else {
                    // Other errors
                    console.error('Login error:', error);
                    let errorMessage = 'Login failed: ' + error.message;
                    
                    if (error.code === 'auth/network-request-failed') {
                        errorMessage = 'Network error. Please check your internet connection.';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = 'Too many login attempts. Please try again later.';
                    }
                    
                    showAlert(alertDiv, '‚ùå ' + errorMessage, 'error');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Login to Dashboard';
                }
            }
        }

        function logoutAdmin() {
            if (auth) {
                auth.signOut();
            }
        }

        function showAlert(element, message, type) {
            element.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => element.innerHTML = '', 5000);
        }

        function showAdminAlert(message, type) {
            showAlert(document.getElementById('adminAlert'), message, type);
        }

        // Check if expiration date is expired or expiring soon
        function getExpirationStatus(expirationDate) {
            if (!expirationDate) {
                return 'expired';
            }
            
            try {
                const now = new Date();
                const expiration = new Date(expirationDate);
                
                if (isNaN(expiration.getTime())) {
                    return 'expired';
                }
                
                const diffTime = expiration - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 0) {
                    return 'expired';
                } else if (diffDays <= 7) {
                    return 'soon';
                } else {
                    return 'active';
                }
            } catch (error) {
                console.error('Error checking expiration:', error);
                return 'expired';
            }
        }

        // Admin functions
        async function loadAllData() {
            try {
                await loadUsers();
                await loadBannedUsers();
                updateStatistics();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadUsers() {
            try {
                const usersRef = rdb.ref('users');
                const snapshot = await usersRef.once('value');
                
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';
                
                if (snapshot.exists()) {
                    const usersObject = snapshot.val();
                    let hasUsers = false;
                    
                    Object.keys(usersObject).forEach(userId => {
                        const userData = usersObject[userId];
                        
                        // Filter based on user type
                        if (currentUserType === 'admins' && userData.role !== 'admin') return;
                        if (currentUserType === 'users' && userData.role === 'admin') return;
                        
                        hasUsers = true;
                        const status = userData.status === 'banned' ? 'banned' : getExpirationStatus(userData.expiration);
                        const devicesUsed = userData.devices ? Object.keys(userData.devices).length : 0;
                        
                        const expirationStatus = getExpirationStatus(userData.expiration);
                        let expirationClass = '';
                        let expirationText = formatExpirationDate(userData.expiration);
                        
                        if (expirationStatus === 'expired') {
                            expirationClass = 'expiration-expired';
                            expirationText = 'EXPIRED - ' + expirationText;
                        } else if (expirationStatus === 'soon') {
                            expirationClass = 'expiration-soon';
                            expirationText = 'SOON - ' + expirationText;
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="email-column">${userData.email} ${userData.role === 'admin' ? '<span style="color: var(--color-warning);">(Admin)</span>' : ''}</td>
                            <td class="device-column">${userData.device_limit}</td>
                            <td class="device-column">${devicesUsed}/${userData.device_limit}</td>
                            <td class="expiration-column expiration-date ${expirationClass}">${expirationText}</td>
                            <td class="status-column"><span class="status-badge status-${status}">${status}</span></td>
                            <td class="actions-column">
                                <button class="btn btn-sm" onclick="viewUserDevices('${userId}', '${userData.email}')">üì± Devices</button>
                                <button class="btn btn-sm" onclick="editUser('${userId}', '${userData.email}')">‚úèÔ∏è Edit</button>
                                <button class="btn btn-info btn-sm" onclick="shareUser('${userId}', '${userData.email}')">üì§ Share</button>
                                ${status !== 'banned' ? 
                                    `<button class="btn btn-danger btn-sm" onclick="banUser('${userId}', '${userData.email}')">Ban</button>` :
                                    `<button class="btn btn-success btn-sm" onclick="unbanUser('${userId}')">Unban</button>`
                                }
                                <button class="btn btn-sm" onclick="extendSubscription('${userId}', '${userData.email}')">Extend</button>
                                <button class="btn btn-danger btn-sm" onclick="removeAccount('${userId}', '${userData.email}')">üóëÔ∏è</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    if (!hasUsers) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No users found</td></tr>';
                    }
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No users found</td></tr>';
                }
                updateStatistics();
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center;">Error loading users</td></tr>';
            }
        }

        async function loadBannedUsers() {
            try {
                const usersRef = rdb.ref('users');
                const snapshot = await usersRef.once('value');
                
                const tbody = document.getElementById('bannedTableBody');
                tbody.innerHTML = '';
                
                if (snapshot.exists()) {
                    const usersObject = snapshot.val();
                    let hasBannedUsers = false;
                    
                    Object.keys(usersObject).forEach(userId => {
                        const userData = usersObject[userId];
                        if (userData.status === 'banned') {
                            hasBannedUsers = true;
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="email-column">${userData.email}</td>
                                <td class="expiration-column">${userData.banReason || 'No reason provided'}</td>
                                <td class="expiration-column">${userData.banDate ? formatDateTime12hr(userData.banDate) : 'Unknown'}</td>
                                <td class="actions-column">
                                    <button class="btn btn-success btn-sm" onclick="unbanUser('${userId}')">Unban</button>
                                    <button class="btn btn-danger btn-sm" onclick="removeAccount('${userId}', '${userData.email}')">üóëÔ∏è</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        }
                    });
                    
                    if (!hasBannedUsers) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No banned users</td></tr>';
                    }
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No banned users</td></tr>';
                }
                updateStatistics();
            } catch (error) {
                console.error('Error loading banned users:', error);
            }
        }

        function updateStatistics() {
            const usersTable = document.getElementById('usersTableBody');
            const bannedTable = document.getElementById('bannedTableBody');
            
            const totalUsers = usersTable.querySelectorAll('tr').length - (usersTable.innerHTML.includes('No users') ? 0 : 1);
            let bannedUsers = 0;
            let activeUsers = 0;
            let totalDevices = 0;
            
            Array.from(usersTable.querySelectorAll('tr')).forEach(row => {
                const statusBadge = row.querySelector('.status-badge');
                if (statusBadge) {
                    if (statusBadge.textContent === 'active') {
                        activeUsers++;
                    } else if (statusBadge.textContent === 'banned') {
                        bannedUsers++;
                    }
                }
                const deviceText = row.cells[2]?.textContent;
                if (deviceText) {
                    const devicesUsed = parseInt(deviceText.split('/')[0]) || 0;
                    totalDevices += devicesUsed;
                }
            });
            
            document.getElementById('statTotalUsers').textContent = totalUsers;
            document.getElementById('statActiveUsers').textContent = activeUsers;
            document.getElementById('statBannedUsers').textContent = bannedUsers;
            document.getElementById('statTotalDevices').textContent = totalDevices;
        }

        async function createUser() {
            const email = document.getElementById('userEmail').value;
            const userKey = document.getElementById('userKey').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            const deviceLimit = parseInt(document.getElementById('userDeviceLimit').value);
            const expirationDays = parseInt(document.getElementById('userExpiration').value);

            if (!email || !userKey || !password) {
                alert('Please fill all required fields');
                return;
            }

            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            if (!userKey.trim()) {
                alert('User Key cannot be empty');
                return;
            }

            try {
                // Create the user in Firebase Authentication
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const userId = userCredential.user.uid;

                // Create user data in Realtime Database
                const userData = {
                    email: email,
                    user_key: userKey,
                    device_limit: deviceLimit,
                    expiration: new Date(Date.now() + expirationDays * 24 * 60 * 60 * 1000).toISOString(),
                    devices: {},
                    created_at: new Date().toISOString(),
                    status: 'active',
                    role: role
                };

                await rdb.ref('users/' + userId).set(userData);

                closeModal('createUserModal');
                // Clear form
                document.getElementById('userEmail').value = '';
                document.getElementById('userKey').value = 'USER123';
                document.getElementById('userPassword').value = 'User123!';

                showAdminAlert('‚úÖ User created successfully!', 'success');
                loadUsers();

            } catch (error) {
                console.error('Error creating user:', error);
                alert('‚ùå Error creating user: ' + error.message);
            }
        }

        // Edit user function - shows both expiration and user key editing
        async function editUser(userId, email) {
            selectedUserId = userId;
            
            // Get current expiration date and user key
            const userRef = rdb.ref('users/' + userId);
            const snapshot = await userRef.once('value');
            
            if (snapshot.exists()) {
                const userData = snapshot.val();
                const currentExpiration = userData.expiration ? formatExpirationDate(userData.expiration) : '';
                document.getElementById('editExpirationDate').value = currentExpiration;
                document.getElementById('editDeviceLimit').value = userData.device_limit || 3;
                
                // Set current user key
                currentUserKey = userData.user_key || 'USER123';
                document.getElementById('currentUserKeyDisplay').textContent = '‚Ä¢'.repeat(currentUserKey.length);
                
                // Set current password (for display only)
                currentUserPassword = 'User123!'; // Default password for display
                document.getElementById('currentPasswordDisplay').textContent = '‚Ä¢'.repeat(currentUserPassword.length);
            }
            
            // Clear password and user key fields
            document.getElementById('editUserKey').value = '';
            document.getElementById('editUserPassword').value = '';
            
            // Reset visibility states
            currentUserKeyVisible = false;
            currentPasswordVisible = false;
            
            document.getElementById('editUserModal').style.display = 'flex';
        }

        // Save user edits (expiration, user key, and password)
        async function saveUserEdits() {
            const expirationInput = document.getElementById('editExpirationDate').value;
            const deviceLimit = parseInt(document.getElementById('editDeviceLimit').value);
            const newUserKey = document.getElementById('editUserKey').value;
            const newPassword = document.getElementById('editUserPassword').value;
            
            if (!expirationInput) {
                alert('Please enter an expiration date');
                return;
            }
            
            // Parse the date input
            const newExpiration = parseDateTime12hr(expirationInput);
            
            if (!newExpiration || isNaN(newExpiration.getTime())) {
                alert('Invalid date format. Please use: YYYY-MM-DD HH:MM:SS AM/PM');
                return;
            }
            
            try {
                const updates = {
                    expiration: newExpiration.toISOString(),
                    device_limit: deviceLimit,
                    last_updated: new Date().toISOString(),
                    updated_by: currentUser.email
                };
                
                // Update user key if provided
                if (newUserKey) {
                    if (!newUserKey.trim()) {
                        alert('User Key cannot be empty');
                        return;
                    }
                    updates.user_key = newUserKey;
                    currentUserKey = newUserKey;
                    document.getElementById('currentUserKeyDisplay').textContent = '‚Ä¢'.repeat(currentUserKey.length);
                }
                
                // Update expiration date and user key in database
                await rdb.ref('users/' + selectedUserId).update(updates);
                
                // Update password if provided
                if (newPassword) {
                    if (newPassword.length < 6) {
                        alert('Password must be at least 6 characters');
                        return;
                    }
                    
                    try {
                        // Get the user from Firebase Auth to update password
                        const user = auth.currentUser;
                        
                        if (user && user.uid === selectedUserId) {
                            // If editing current user, use updatePassword
                            await user.updatePassword(newPassword);
                        } else {
                            // For other users, we need to use the Admin SDK on server
                            // For demo, we'll just store the password in the database
                            await rdb.ref('users/' + selectedUserId).update({
                                password: newPassword,
                                password_updated: new Date().toISOString()
                            });
                        }
                        
                        // Update the stored password for display
                        currentUserPassword = newPassword;
                        document.getElementById('currentPasswordDisplay').textContent = '‚Ä¢'.repeat(currentUserPassword.length);
                        
                    } catch (authError) {
                        console.error('Error updating password:', authError);
                        // If we can't update in Auth, at least store in database
                        await rdb.ref('users/' + selectedUserId).update({
                            password: newPassword,
                            password_updated: new Date().toISOString()
                        });
                        currentUserPassword = newPassword;
                    }
                }
                
                closeModal('editUserModal');
                showAdminAlert('‚úÖ User updated successfully!', 'success');
                loadUsers();
                
            } catch (error) {
                console.error('Error updating user:', error);
                showAdminAlert('‚ùå Error updating user: ' + error.message, 'error');
            }
        }

        // Share user details
        async function shareUser(userId, email) {
            selectedUserId = userId;
            
            try {
                const userRef = rdb.ref('users/' + userId);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const devicesUsed = userData.devices ? Object.keys(userData.devices).length : 0;
                    
                    // Format the share content
                    const shareContent = `Account: ${userData.email}
User Key: ${userData.user_key || 'No key set'}
Password: ${currentUserPassword || 'User123!'}
Expiration: ${formatExpirationDate(userData.expiration)}
Created: ${formatDateTime12hr(userData.created_at)}
Device Logged: ${devicesUsed}/${userData.device_limit}
Device Limit: ${userData.device_limit}`;
                    
                    document.getElementById('shareContent').textContent = shareContent;
                    document.getElementById('shareUserModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading user for sharing:', error);
                showAdminAlert('‚ùå Error loading user details: ' + error.message, 'error');
            }
        }

        // Copy share content to clipboard
        function copyShareContent() {
            const shareContent = document.getElementById('shareContent').textContent;
            navigator.clipboard.writeText(shareContent).then(() => {
                showAdminAlert('‚úÖ Account details copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showAdminAlert('‚ùå Failed to copy to clipboard', 'error');
            });
        }

        // Remove account
        async function removeAccount(userId, email) {
            if (confirm(`Are you sure you want to permanently delete the account for ${email}? This action cannot be undone!`)) {
                try {
                    // Delete from Firebase Auth
                    await auth.deleteUser(userId);
                    
                    // Delete from Realtime Database
                    await rdb.ref('users/' + userId).remove();
                    
                    showAdminAlert('‚úÖ Account deleted successfully!', 'success');
                    loadAllData();
                } catch (error) {
                    console.error('Error deleting account:', error);
                    
                    // If we can't delete from Auth (might not have permission), at least delete from DB
                    try {
                        await rdb.ref('users/' + userId).remove();
                        showAdminAlert('‚úÖ Account data removed from database!', 'success');
                        loadAllData();
                    } catch (dbError) {
                        showAdminAlert('‚ùå Error deleting account: ' + error.message, 'error');
                    }
                }
            }
        }

        // Device Management Functions
        async function viewUserDevices(userId, userEmail) {
            selectedUserId = userId;
            try {
                const userRef = rdb.ref('users/' + userId);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const devices = userData.devices || {};
                    
                    document.getElementById('devicesModalTitle').textContent = `Devices for: ${userEmail}`;
                    const devicesList = document.getElementById('devicesList');
                    devicesList.innerHTML = '';
                    
                    if (Object.keys(devices).length === 0) {
                        devicesList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No devices registered</div>';
                    } else {
                        Object.keys(devices).forEach(deviceId => {
                            const device = devices[deviceId];
                            const deviceItem = document.createElement('div');
                            deviceItem.className = `device-item ${device.status === 'banned' ? 'device-banned' : 'device-active'}`;
                            
                            deviceItem.innerHTML = `
                                <div class="device-header">
                                    <strong>${device.device_name || 'Unknown Device'}</strong>
                                    <span class="status-badge status-${device.status === 'banned' ? 'banned' : 'active'}">
                                        ${device.status === 'banned' ? 'BANNED' : 'ACTIVE'}
                                    </span>
                                </div>
                                <div class="device-info">
                                    <div><strong>Device ID:</strong> ${deviceId}</div>
                                    <div><strong>Last Login:</strong> ${device.last_login ? formatDateTime12hr(device.last_login) : 'Never'}</div>
                                    <div><strong>IP Address:</strong> ${device.ip_address || 'Unknown'}</div>
                                    <div><strong>User Agent:</strong> ${device.user_agent ? device.user_agent.substring(0, 50) + '...' : 'Unknown'}</div>
                                </div>
                                ${device.ban_reason ? `<div style="margin-top: 10px; color: var(--color-danger);"><strong>Ban Reason:</strong> ${device.ban_reason}</div>` : ''}
                                <div class="device-actions">
                                    ${device.status === 'banned' ? 
                                        `<button class="btn btn-success btn-sm" onclick="unbanDevice('${userId}', '${deviceId}')">Unban Device</button>` :
                                        `<button class="btn btn-warning btn-sm" onclick="showBanDeviceModal('${userId}', '${deviceId}', '${device.device_name || 'Unknown Device'}')">Ban Device</button>`
                                    }
                                    <button class="btn btn-danger btn-sm" onclick="removeDevice('${userId}', '${deviceId}')">Remove</button>
                                </div>
                            `;
                            devicesList.appendChild(deviceItem);
                        });
                    }
                    
                    document.getElementById('viewDevicesModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading devices:', error);
                showAdminAlert('‚ùå Error loading devices: ' + error.message, 'error');
            }
        }

        // Remove all devices for a user
        async function removeAllDevices() {
            if (confirm('Are you sure you want to remove ALL devices for this user? The user will need to login again from all devices.')) {
                try {
                    await rdb.ref(`users/${selectedUserId}/devices`).remove();
                    showAdminAlert('‚úÖ All devices removed successfully!', 'success');
                    closeModal('viewDevicesModal');
                } catch (error) {
                    console.error('Error removing all devices:', error);
                    showAdminAlert('‚ùå Error removing all devices: ' + error.message, 'error');
                }
            }
        }

        function showBanDeviceModal(userId, deviceId, deviceName) {
            selectedUserId = userId;
            selectedDeviceId = deviceId;
            document.getElementById('banDeviceModal').style.display = 'flex';
        }

        async function confirmBanDevice() {
            const reason = document.getElementById('banDeviceReason').value;
            const notes = document.getElementById('banDeviceNotes').value;
            
            if (!reason) {
                alert('Please enter a ban reason');
                return;
            }

            try {
                await rdb.ref(`users/${selectedUserId}/devices/${selectedDeviceId}`).update({
                    status: 'banned',
                    ban_reason: reason,
                    ban_notes: notes,
                    banned_by: currentUser.email,
                    banned_at: new Date().toISOString()
                });
                
                closeModal('banDeviceModal');
                showAdminAlert('‚úÖ Device banned successfully!', 'success');
                viewUserDevices(selectedUserId, ''); // Refresh devices list
                
                // Clear form
                document.getElementById('banDeviceReason').value = '';
                document.getElementById('banDeviceNotes').value = '';
                
            } catch (error) {
                console.error('Error banning device:', error);
                showAdminAlert('‚ùå Error banning device: ' + error.message, 'error');
            }
        }

        async function unbanDevice(userId, deviceId) {
            try {
                await rdb.ref(`users/${userId}/devices/${deviceId}`).update({
                    status: 'active',
                    ban_reason: null,
                    ban_notes: null,
                    banned_by: null,
                    banned_at: null
                });
                
                showAdminAlert('‚úÖ Device unbanned successfully!', 'success');
                viewUserDevices(userId, ''); // Refresh devices list
            } catch (error) {
                console.error('Error unbanning device:', error);
                showAdminAlert('‚ùå Error unbanning device: ' + error.message, 'error');
            }
        }

        async function removeDevice(userId, deviceId) {
            if (confirm('Are you sure you want to remove this device? The user will need to login again from this device.')) {
                try {
                    await rdb.ref(`users/${userId}/devices/${deviceId}`).remove();
                    showAdminAlert('‚úÖ Device removed successfully!', 'success');
                    viewUserDevices(userId, ''); // Refresh devices list
                } catch (error) {
                    console.error('Error removing device:', error);
                    showAdminAlert('‚ùå Error removing device: ' + error.message, 'error');
                }
            }
        }

        // Maintenance Functions
        async function checkMaintenanceStatus() {
            try {
                const maintenanceRef = rdb.ref('maintenance');
                const snapshot = await maintenanceRef.once('value');
                
                if (snapshot.exists()) {
                    const maintenanceData = snapshot.val();
                    if (maintenanceData.active) {
                        // Show maintenance banner
                        document.getElementById('maintenanceBanner').classList.remove('hidden');
                        document.getElementById('maintenanceMessage').textContent = maintenanceData.reason || 'System maintenance in progress';
                        document.getElementById('maintenanceTime').textContent = formatDateTime12hr(maintenanceData.started_at);
                        
                        // Show current maintenance info in settings
                        document.getElementById('currentMaintenanceInfo').style.display = 'block';
                        document.getElementById('currentMaintenanceDetails').innerHTML = `
                            <div><strong>Reason:</strong> ${maintenanceData.reason || 'No reason provided'}</div>
                            <div><strong>Started:</strong> ${formatDateTime12hr(maintenanceData.started_at)}</div>
                            <div><strong>Started By:</strong> ${maintenanceData.started_by || 'Unknown'}</div>
                        `;
                    } else {
                        document.getElementById('maintenanceBanner').classList.add('hidden');
                        document.getElementById('currentMaintenanceInfo').style.display = 'none';
                    }
                } else {
                    document.getElementById('maintenanceBanner').classList.add('hidden');
                    document.getElementById('currentMaintenanceInfo').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking maintenance status:', error);
            }
        }

        async function startMaintenance() {
            const reason = document.getElementById('maintenanceReason').value;
            
            if (!reason) {
                alert('Please enter a maintenance reason');
                return;
            }

            try {
                const maintenanceData = {
                    active: true,
                    reason: reason,
                    started_at: new Date().toISOString(),
                    started_by: currentUser.email
                };

                await rdb.ref('maintenance').set(maintenanceData);
                
                showAdminAlert('‚úÖ Maintenance started successfully!', 'success');
                checkMaintenanceStatus();
                
                // Clear form
                document.getElementById('maintenanceReason').value = '';
                
            } catch (error) {
                console.error('Error starting maintenance:', error);
                showAdminAlert('‚ùå Error starting maintenance: ' + error.message, 'error');
            }
        }

        async function stopMaintenance() {
            try {
                await rdb.ref('maintenance').update({
                    active: false,
                    stopped_at: new Date().toISOString(),
                    stopped_by: currentUser.email
                });
                
                showAdminAlert('‚úÖ Maintenance stopped successfully!', 'success');
                checkMaintenanceStatus();
                
            } catch (error) {
                console.error('Error stopping maintenance:', error);
                showAdminAlert('‚ùå Error stopping maintenance: ' + error.message, 'error');
            }
        }

        // Update Management Functions
        async function checkCurrentUpdate() {
            try {
                const updateRef = rdb.ref('current_update');
                const snapshot = await updateRef.once('value');
                
                if (snapshot.exists()) {
                    const updateData = snapshot.val();
                    document.getElementById('currentUpdateInfo').classList.remove('hidden');
                    
                    let updateTypeBadge = '';
                    switch(updateData.type) {
                        case 'feature':
                            updateTypeBadge = '<span class="status-badge status-active">Feature</span>';
                            break;
                        case 'bugfix':
                            updateTypeBadge = '<span class="status-badge status-warning">Bug Fix</span>';
                            break;
                        case 'security':
                            updateTypeBadge = '<span class="status-badge status-danger">Security</span>';
                            break;
                        case 'maintenance':
                            updateTypeBadge = '<span class="status-badge status-info">Maintenance</span>';
                            break;
                        default:
                            updateTypeBadge = '<span class="status-badge">Update</span>';
                    }
                    
                    const notesHtml = updateData.notes ? 
                        updateData.notes.split('\n').map(note => 
                            `<div class="update-item">${note}</div>`
                        ).join('') : '';
                    
                    document.getElementById('currentUpdateDetails').innerHTML = `
                        <div><strong>Version:</strong> ${updateData.version}</div>
                        <div><strong>Title:</strong> ${updateData.title}</div>
                        <div><strong>Type:</strong> ${updateTypeBadge}</div>
                        <div><strong>Published:</strong> ${formatDateTime12hr(updateData.published_at)}</div>
                        <div style="margin-top: 10px;"><strong>Notes:</strong></div>
                        ${notesHtml}
                    `;
                } else {
                    document.getElementById('currentUpdateInfo').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error checking current update:', error);
            }
        }

        async function publishUpdate() {
            const version = document.getElementById('updateVersion').value;
            const title = document.getElementById('updateTitle').value;
            const notes = document.getElementById('updateNotes').value;
            const type = document.getElementById('updateType').value;

            if (!version || !title || !notes) {
                alert('Please fill all update fields');
                return;
            }

            try {
                const updateData = {
                    version: version,
                    title: title,
                    notes: notes,
                    type: type,
                    published_at: new Date().toISOString(),
                    published_by: currentUser.email,
                    requires_maintenance: type === 'maintenance' || type === 'security'
                };

                await rdb.ref('current_update').set(updateData);
                
                // NEW: Check if system version matches update version - stop maintenance if it does
                const systemVersion = document.getElementById('systemVersion').value;
                if (systemVersion === version) {
                    // Stop maintenance automatically when versions match
                    await rdb.ref('maintenance').update({
                        active: false,
                        stopped_at: new Date().toISOString(),
                        stopped_by: currentUser.email,
                        stopped_reason: 'System version updated to match update version'
                    });
                    showAdminAlert('‚úÖ Update published and maintenance stopped automatically!', 'success');
                } else {
                    // If this update requires maintenance, automatically start maintenance
                    if (updateData.requires_maintenance) {
                        const maintenanceData = {
                            active: true,
                            reason: `System update: ${title}`,
                            started_at: new Date().toISOString(),
                            started_by: currentUser.email,
                            update_version: version
                        };
                        await rdb.ref('maintenance').set(maintenanceData);
                        showAdminAlert('‚úÖ Update published and maintenance started!', 'success');
                    } else {
                        showAdminAlert('‚úÖ Update published successfully!', 'success');
                    }
                }
                
                checkCurrentUpdate();
                checkMaintenanceStatus();
                
                // Clear form
                document.getElementById('updateVersion').value = '';
                document.getElementById('updateTitle').value = '';
                document.getElementById('updateNotes').value = '';
                
            } catch (error) {
                console.error('Error publishing update:', error);
                showAdminAlert('‚ùå Error publishing update: ' + error.message, 'error');
            }
        }

        async function loadSystemSettings() {
            try {
                const settingsRef = rdb.ref('system_settings');
                const snapshot = await settingsRef.once('value');
                
                if (snapshot.exists()) {
                    const settings = snapshot.val();
                    document.getElementById('systemName').value = settings.system_name || 'Starzone Updator v3.1';
                    document.getElementById('systemVersion').value = settings.system_version || 'v3.1';
                    document.getElementById('defaultDeviceLimit').value = settings.default_device_limit || 3;
                    document.getElementById('defaultSubscriptionDays').value = settings.default_subscription_days || 30;
                    document.getElementById('forgotPasswordUrl').value = settings.forgot_password_url || 'https://t.me/r3nz75';
                }
            } catch (error) {
                console.error('Error loading system settings:', error);
            }
        }

        async function saveSystemSettings() {
            try {
                const systemName = document.getElementById('systemName').value;
                const systemVersion = document.getElementById('systemVersion').value;
                const defaultDeviceLimit = parseInt(document.getElementById('defaultDeviceLimit').value);
                const defaultSubscriptionDays = parseInt(document.getElementById('defaultSubscriptionDays').value);
                const forgotPasswordUrl = document.getElementById('forgotPasswordUrl').value;

                const settings = {
                    system_name: systemName,
                    system_version: systemVersion,
                    default_device_limit: defaultDeviceLimit,
                    default_subscription_days: defaultSubscriptionDays,
                    forgot_password_url: forgotPasswordUrl,
                    last_updated: new Date().toISOString(),
                    updated_by: currentUser.email
                };

                await rdb.ref('system_settings').set(settings);
                showAdminAlert('‚úÖ System settings saved successfully!', 'success');
                
                // NEW: Check if system version matches current update version - stop maintenance if it does
                const updateRef = rdb.ref('current_update');
                const snapshot = await updateRef.once('value');
                
                if (snapshot.exists()) {
                    const updateData = snapshot.val();
                    if (systemVersion === updateData.version) {
                        // Stop maintenance automatically when versions match
                        await rdb.ref('maintenance').update({
                            active: false,
                            stopped_at: new Date().toISOString(),
                            stopped_by: currentUser.email,
                            stopped_reason: 'System version updated to match current update version'
                        });
                        showAdminAlert('‚úÖ System settings saved and maintenance stopped automatically!', 'success');
                        checkMaintenanceStatus();
                    }
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showAdminAlert('‚ùå Error saving system settings: ' + error.message, 'error');
            }
        }

        // Create demo users (non-admin)
        async function createDemoUsers() {
            try {
                const demoUsers = [
                    { email: 'demo1@example.com', user_key: 'DEMO001', password: 'Demo123!', device_limit: 2, days: 15, role: 'user' },
                    { email: 'demo2@example.com', user_key: 'DEMO002', password: 'Demo123!', device_limit: 3, days: 30, role: 'user' },
                    { email: 'demo3@example.com', user_key: 'DEMO003', password: 'Demo123!', device_limit: 1, days: 7, role: 'user' }
                ];

                let createdCount = 0;

                for (const demoUser of demoUsers) {
                    try {
                        // Check if user already exists in Firebase Auth
                        try {
                            // Try to sign in first (to check if user exists)
                            await auth.signInWithEmailAndPassword(demoUser.email, demoUser.password);
                            // If successful, user exists - sign out and skip
                            await auth.signOut();
                            console.log(`User ${demoUser.email} already exists, skipping...`);
                            continue;
                        } catch (authError) {
                            // User doesn't exist or wrong password - proceed with creation
                            if (authError.code !== 'auth/user-not-found' && authError.code !== 'auth/wrong-password') {
                                throw authError;
                            }
                        }

                        // Create auth account
                        const userCredential = await auth.createUserWithEmailAndPassword(demoUser.email, demoUser.password);
                        
                        // Create database record
                        const userData = {
                            email: demoUser.email,
                            user_key: demoUser.user_key,
                            device_limit: demoUser.device_limit,
                            expiration: new Date(Date.now() + demoUser.days * 24 * 60 * 60 * 1000).toISOString(),
                            devices: {},
                            created_at: new Date().toISOString(),
                            status: 'active',
                            role: demoUser.role
                        };

                        await rdb.ref('users/' + userCredential.user.uid).set(userData);
                        createdCount++;
                        
                        console.log(`Created demo user: ${demoUser.email}`);
                        
                    } catch (error) {
                        console.error(`Error creating demo user ${demoUser.email}:`, error);
                        // Continue with next user even if one fails
                    }
                }

                showAdminAlert(`‚úÖ Created ${createdCount} demo users!`, 'success');
                loadUsers();
                
            } catch (error) {
                console.error('Error creating demo users:', error);
                showAdminAlert('‚ùå Error creating demo users: ' + error.message, 'error');
            }
        }

        async function initializeDemoData() {
            try {
                const demoUsers = [
                    { email: 'user1@example.com', user_key: 'USER001', password: 'User123!', device_limit: 3, days: 30, role: 'user' },
                    { email: 'user2@example.com', user_key: 'USER002', password: 'User123!', device_limit: 5, days: 60, role: 'user' },
                    { email: 'user3@example.com', user_key: 'USER003', password: 'User123!', device_limit: 2, days: 15, role: 'user' }
                ];

                let createdCount = 0;

                for (const demoUser of demoUsers) {
                    try {
                        // Check if user already exists in Firebase Auth
                        try {
                            // Try to sign in first (to check if user exists)
                            await auth.signInWithEmailAndPassword(demoUser.email, demoUser.password);
                            // If successful, user exists - sign out and skip
                            await auth.signOut();
                            console.log(`User ${demoUser.email} already exists, skipping...`);
                            continue;
                        } catch (authError) {
                            // User doesn't exist or wrong password - proceed with creation
                            if (authError.code !== 'auth/user-not-found' && authError.code !== 'auth/wrong-password') {
                                throw authError;
                            }
                        }

                        // Create auth account
                        const userCredential = await auth.createUserWithEmailAndPassword(demoUser.email, demoUser.password);
                        
                        // Create database record
                        const userData = {
                            email: demoUser.email,
                            user_key: demoUser.user_key,
                            device_limit: demoUser.device_limit,
                            expiration: new Date(Date.now() + demoUser.days * 24 * 60 * 60 * 1000).toISOString(),
                            devices: {},
                            created_at: new Date().toISOString(),
                            status: 'active',
                            role: demoUser.role
                        };

                        await rdb.ref('users/' + userCredential.user.uid).set(userData);
                        createdCount++;
                        
                        console.log(`Created demo user: ${demoUser.email}`);
                        
                    } catch (error) {
                        console.error(`Error creating demo user ${demoUser.email}:`, error);
                        // Continue with next user even if one fails
                    }
                }

                showAdminAlert(`‚úÖ Created ${createdCount} demo users!`, 'success');
                loadUsers();
                
            } catch (error) {
                console.error('Error creating demo data:', error);
                showAdminAlert('‚ùå Error creating demo data: ' + error.message, 'error');
            }
        }

        async function testDatabaseConnection() {
            try {
                const testRef = rdb.ref('test_connection');
                await testRef.set({ timestamp: Date.now(), test: 'success' });
                await testRef.remove();
                showAdminAlert('‚úÖ Database connection successful!', 'success');
            } catch (error) {
                showAdminAlert('‚ùå Database connection failed: ' + error.message, 'error');
            }
        }

        async function checkSetupStatus() {
            try {
                const usersRef = rdb.ref('users');
                const snapshot = await usersRef.once('value');
                const statusElement = document.getElementById('setupStatus');
                
                if (snapshot.exists()) {
                    const userCount = Object.keys(snapshot.val()).length;
                    statusElement.textContent = `‚úÖ System Ready (${userCount} users)`;
                    statusElement.style.color = 'var(--color-success)';
                } else {
                    statusElement.textContent = '‚ö†Ô∏è No users found - Create demo data';
                    statusElement.style.color = '#f59e0b';
                }
            } catch (error) {
                document.getElementById('setupStatus').textContent = '‚ùå Connection Error';
                document.getElementById('setupStatus').style.color = 'var(--color-danger)';
            }
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear ALL data? This cannot be undone!')) {
                showAdminAlert('üóëÔ∏è Clearing all data...', 'error');
                // Note: In production, you'd want to implement proper data clearing logic
            }
        }

        // Fixed Ban System - Keep user in users collection but mark as banned
        async function banUser(userId, email) {
            const reason = prompt(`Enter ban reason for ${email}:`, 'Violation of terms');
            if (reason) {
                try {
                    // Update user status to banned instead of moving to separate collection
                    await rdb.ref('users/' + userId).update({
                        status: 'banned',
                        banReason: reason,
                        bannedBy: currentUser.email,
                        banDate: new Date().toISOString()
                    });
                    
                    showAdminAlert(`‚úÖ Banned ${email}`, 'success');
                    loadAllData();
                } catch (error) {
                    console.error('Error banning user:', error);
                    showAdminAlert('‚ùå Error banning user: ' + error.message, 'error');
                }
            }
        }

        async function unbanUser(userId) {
            try {
                // Remove ban data and restore user status
                await rdb.ref('users/' + userId).update({
                    status: 'active',
                    banReason: null,
                    bannedBy: null,
                    banDate: null
                });
                
                showAdminAlert('‚úÖ User unbanned', 'success');
                loadAllData();
            } catch (error) {
                console.error('Error unbanning user:', error);
                showAdminAlert('‚ùå Error unbanning user: ' + error.message, 'error');
            }
        }

        async function extendSubscription(userId, email) {
            const days = prompt(`Extend subscription for ${email} by how many days?`, "30");
            if (days && !isNaN(days)) {
                const userRef = rdb.ref('users/' + userId);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const currentExpiration = new Date(userData.expiration);
                    const newExpiration = new Date(Math.max(currentExpiration.getTime(), Date.now()) + parseInt(days) * 24 * 60 * 60 * 1000);
                    
                    await userRef.update({
                        expiration: newExpiration.toISOString(),
                        last_updated: new Date().toISOString(),
                        updated_by: currentUser.email
                    });
                    
                    showAdminAlert(`‚úÖ Subscription extended for ${email}`, 'success');
                    loadUsers();
                }
            }
        }

        // Initialize the app
        window.addEventListener('load', initApp);
    </script>
</body>
</html>